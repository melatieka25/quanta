<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
  <title>Quanta</title>
  <object th:include="fragments/fragment :: css" th:remove="tag"></object>
  <object th:include="fragments/fragment :: js" th:remove="tag"></object>
  <link href='https://fonts.googleapis.com/css?family=DM Sans' rel='stylesheet'>

<body>
<style>
  body {
    font-family: 'DM Sans';
  }
</style>
<nav th:replace="fragments/fragment :: navbar('')"></nav>
<div class="alert alert-success" role="alert" th:text="${message}" th:if="${message}"></div>
<div class="alert alert-danger" role="alert" th:text="${errorMessage}" th:if="${errorMessage}"></div>
<div class="container m-5">
  <div class="container" style="width:600px;">
    <div class="justify-content-center">
      <h2 style="font-weight: bolder;">Tambah Konsultasi</h2>
      <br>
      <form name="request-form" th:action="@{/konsultasi/add}" th:object="${konsultasi}" method="POST">

        <div class="card-body">
          <div class="container">
            <div class="row">
              <div class="col">
                Mata Pelajaran: <br>
                <select  class="form-select" id="mapel-dropdown" name="mataPelajaran" required>
                  <option hidden disabled selected value>Pilih mata pelajaran...</option>
                  <option th:each="mapel, iterationStatus : ${listMapel}"
                          th:value="${mapel.id}"
                          th:text="${mapel.name}"></option>
                </select>
                <br>

                Pengajar: <br>
                <select class="form-select" id="pengajar-dropdown" name="pengajarMapel" required>
                  <option hidden disabled selected value>Pilih pengajar...</option>
                </select>
                <br>

                Tanggal: <br>
                <input class="form-control datepicker" id="tanggal" type="date" name="tanggal" required/>
                <br>

                Waktu <br>
                <select class="form-select" id="waktu-dropdown" name="waktuMulai" type="time" required>
                  <option hidden disabled selected value>--:-- - --:--</option>
                </select>
                <br>

                Topik : <br>
                <input class="form-control" type="text" placeholder="Topik..." name="topik" th:value="${topik}" th:text="${topik}"required/>
                <br>

              </div>
            </div>

          </div>

        </div>



        <a class="btn btn-secondary" onclick="history.go(-1)">Kembali</a>
          <a class="btn" style="background-color: #31318B; color: white;" data-toggle="modal" data-target="#modal-update">Submit</a>

          <!-- Modal -->
          <div class="modal fade" id="modal-update" tabindex="-1" role="dialog" aria-labelledby="popupLabel" aria-hidden="true">
              <div class="modal-dialog" role="document">
                  <div class="modal-content">
                      <div class="modal-header">
                          <h5 class="modal-title" id="popupLabel"><strong>Mohon tunggu pengajar untuk memverifikasi permintaan konsultasi</strong></h5>
                          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                              <span aria-hidden="true">&times;</span>
                          </button>
                      </div>
                      <div class="modal-body">
                          Bila pengajar belum melakukan verifikasi hingga 2 jam sebelum konsultasi dimulai
                          maka permintaan konsultasi akan kadaluarsa.
                          <br>
                          <br>
                          Apakah Anda yakin ingin membuat konsultasi ini?
                          <br>
                      </div>
                      <div class="modal-footer">
                          <button type="button" class="btn btn-secondary" data-dismiss="modal">Kembali</button>
                          <button class="btn btn-primary" type="submit" name="save" style="background-color: #31318B; border-color: #31318B">Yakin</button>
                      </div>
                  </div>
                  <br>
              </div>
          </div>
          <!--end modal-->



      </form>
    </div>
  </div>
</div>

</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script type="text/javascript">
  $(document).ready(function () {
    $("#mapel-dropdown").change(function(){
      var mapel_id=$(this).find(':selected').val();

      var json_url="/api/v1/konsultasi/get-pengajar-mapel/" + mapel_id;

      // get json data
      jQuery.getJSON(json_url, function(data){
        $("#pengajar-dropdown").html("");
        $("#pengajar-dropdown").append("<option hidden disabled selected value>Pilih pengajar...</option>");
        $("#tanggal").html("");
        $("#tanggal").val(null);
        $("#waktu-dropdown").html("");
        $("#waktu-dropdown").append("<option hidden disabled selected value>--:-- - --:--</option>");

        // put new dropdown values to pengajar dropdown
        jQuery.each(data, function(key, val){
          $("#pengajar-dropdown").append("<option value='" + val.id + "'>" + val.name + "</option>")

        });

      });

    });

      $("#pengajar-dropdown").change(function(){
          $("#tanggal").html("");
          $("#tanggal").val(null);
          $("#waktu-dropdown").html("");
          $("#waktu-dropdown").append("<option hidden disabled selected value>--:-- - --:--</option>");
      });


    //get waktu available
    $("#tanggal").change(
            function(){
        // get id of selected team
              var datetime=$("#tanggal").val();
              var pengajar_id = $("#pengajar-dropdown").find(":selected").val();

        // set json url
        var json_url="/api/v1/konsultasi/get-waktu/" + pengajar_id + "/" + datetime;

              // get json data
        $.getJSON(json_url, function(data){
            if(data.length === 0){
                alert("Tidak ada waktu yang tersedia! Silakan pilih tanggal lain")
                $("#tanggal").html("");
                $("#tanggal").val(null);
                $("#waktu-dropdown").html("");
                $("#waktu-dropdown").append("<option hidden disabled selected value>--:-- - --:--</option>");

                return false;
            } else {
                $("#waktu-dropdown").html("");
                $("#waktu-dropdown").append("<option hidden disabled selected value>--:-- - --:--</option>");

                // put new dropdown values to waktu dropdown
                jQuery.each(data, function(key, val){
                    var menit = ":00"
                    var waktuAwal = new Date();
                    waktuAwal.setHours(val.substring(0,2))

                    var waktuAkhir = new Date();
                    waktuAkhir.setHours(waktuAwal.getHours()+1)

                    $("#waktu-dropdown").append("<option value='" + val + "'>" + waktuAwal.getHours() + menit + " - " +  waktuAkhir.getHours() + menit + "</option>")
                });
            }



        });

    });

    $("#pengajar-dropdown").click(function() {
      var mapel_id = $("#mapel-dropdown").find(":selected").val();
      if(mapel_id == "") {
        alert("Mohon pilih mata pelajaran terlebih dahulu");
        return false;
      }return true;
    })

    $("#tanggal").click(function() {
      var pengajar_id = $("#pengajar-dropdown").find(":selected").val();
      var mapel_id = $("#pengajar-dropdown").find(":selected").val();
      if((pengajar_id == "") && (mapel_id == "")) {
        alert("Mohon pilih mata pelajaran dan pengajar terlebih dahulu");
        return false;
      } else if(pengajar_id == "") {
        alert("Mohon pilih pengajar terlebih dahulu");
        return false;
      }
      return true;
    })



    var today = new Date().toISOString().split('T')[0];
    $("#tanggal").attr('min', today);

    // Everything except weekend days
    const validate = dateString => {
      const day = (new Date(dateString)).getDay();
      const date = (new Date(dateString));

      if (day==0) {
        alert('Konsultasi tidak bisa diadakan di hari Minggu! Silakan pilih hari lain.');
        return false;
      }
      if ((Math.floor((date - Date.now())/8.64e+7)) >= 7 ) {
          alert('Request konsultasi hanya dapat dilakukan maksimal 7 hari sebelum konsultasi dilakukan')
          return false;
        }
      return true;
    }

    // Sets the value to '' in case of an invalid date
    document.querySelector('#tanggal').onchange = evt => {
      if (!validate(evt.target.value)) {
        evt.target.value = '';
      }
    }
  })
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js"></script>

</html>
